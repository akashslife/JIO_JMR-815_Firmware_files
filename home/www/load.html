<?php
//------------------------------------------------------------------------------
function free_cache()
{
  @system("sync;echo 1 > /proc/sys/vm/drop_caches");
}
//------------------------------------------------------------------------------
function getfilesize($filename)
{
 $size = filesize($filename);
    if ($size === false) {
        $fp = fopen($filename, 'r');
        if (!$fp) {
            return false;
        }
        $offset = PHP_INT_MAX - 1;
        $size = (float) $offset;
        if (!fseek($fp, $offset)) {
            return false;
        }
        $chunksize = 8192;
        while (!feof($fp)) {
            $size += strlen(fread($fp, $chunksize));
        }
    } elseif ($size < 0) {
        // Handle overflowed integer...
        $size = sprintf("%u", $size);
    }
    return $size;

}
//------------------------------------------------------------------------------
umask(002); // Added to make created files/dirs group writable
//------------------------------------------------------------------------------
if(isset($_SERVER)) {
	$GLOBALS['__GET']	=&$_GET;
	$GLOBALS['__SERVER']	=&$_SERVER;
} elseif(isset($HTTP_SERVER_VARS)) {
	$GLOBALS['__GET']	=&$HTTP_GET_VARS;
	$GLOBALS['__SERVER']	=&$HTTP_SERVER_VARS;
} else {
	die("<B>ERROR: Your PHP version is too old</B><BR>".
	"You need at least PHP 4.0.0 preferably PHP 4.3.1 or higher.");
}

session_start();
if(isset($_SESSION)) 			$GLOBALS['__SESSION']=&$_SESSION;
elseif(isset($HTTP_SESSION_VARS))	$GLOBALS['__SESSION']=&$HTTP_SESSION_VARS;

ob_start(); // prevent unwanted output
require "./.config/conf.php";


require "./.include/fun_users.php";
load_users();
ob_end_clean(); // get rid of cached unwanted output

//login check
if(isset($GLOBALS['__SESSION']["s_user"])) {
	if(!activate_user($GLOBALS['__SESSION']["s_user"],$GLOBALS['__SESSION']["s_pass"])) {
  header('HTTP/1.1 404 File not found',true);
  exit;
	}
}
else {
  header('HTTP/1.1 404 File not found',true);
  exit;
}

//------------------------------------------------------------------------------
if(isset($GLOBALS['__GET']['path'])) $file= $GLOBALS["home_dir"].$GLOBALS['__GET']['path'];


if(!file_exists($file) or $file==='' or !is_readable($file)){
  header('HTTP/1.1 404 File not found',true);
  exit;
}


$mime = "application/octet-stream"; // The MIME type of the file, this should be replaced with your own.
header('Content-type: ' . $mime); // Send the content type header

$size = getfilesize($file); // The size of the file  


ini_set('max_execution_time', 0); 
$READ_RANGE=4096000*2;

session_write_close(); //for with another request
	
if(isset($_SERVER['HTTP_RANGE'])){ // Check if it's a HTTP range request

    $ranges = array_map(
        'intval', // Parse the parts into integer
        explode(
            '-', // The range separator
            substr($_SERVER['HTTP_RANGE'], 6) // Skip the `bytes=` part of the header
        )
    );
	if($ranges[0] > 0) { $seek_start = intval($ranges[0]); }
	else $seek_start = 0;
//    if($ranges[1] > 0) { $seek_end  =  intval($ranges[1]); } 
    
    $ranges[1] = $seek_start+ $READ_RANGE -1;
    if($ranges[1] >=$size)
        $ranges[1] = $size - 1;
        
    // Send the appropriate headers
    header('HTTP/1.1 206 Partial Content');
    header('Accept-Ranges: bytes');

    header('Content-Length: ' . ($ranges[1] - $ranges[0] +1)); // The size of the range
    //header('Content-Length: ' . $size-$seek_start);    
 
    // Send the ranges we offered

    header(
        sprintf(
            'Content-Range: bytes %d-%d/%d', // The header format
            $ranges[0], // The start range
            $ranges[1], // The end range
            $size // Total size of the file
        )
    );
 
    // It's time to output the file
    $f = fopen($file, 'rb'); // Open the file in binary mode
    $chunkSize = $READ_RANGE/200; // The size of each chunk to output
 
    // Seek to the requested start range
    fseek($f, $ranges[0]);
 
    // Start outputting the data
    while(true){
        // Check if we have outputted all the data requested
        if(ftell($f) >= $ranges[1]){
            break;
        }
 
        // Output the data
        echo fread($f, $chunkSize);
        // Flush the buffer immediately
        flush();
    }
  	fclose($f);
	free_cache();
//	usleep(200);
}
else 
{
    // It's not a range request, output the file anyway
    header('Content-Length: ' . $size);
	Header( "X-LIGHTTPD-send-file: " . $file);
	$fp = fopen($file, 'rb');

	while (!feof($fp)) {
		echo fread($fp, $READ_RANGE);
		flush();
		
		free_cache();

//		usleep(200);
	}
	fclose($fp);

}
exit;
//------------------------------------------------------------------------------
?>
